---
title: "Analyze FEMA data"
author: "Alan Jackson"
format: html
editor: visual
---

## Combine FEMA and church data to analyze

Produce the following:

1. Map of each hazard by convocation, frequency and annualized occurrence
2. Table for each parish of Hazard, Frequency, Annualized Occurrence


```{r setup}

library(tidyverse)

googlecrs <- "EPSG:4326"
localUTM <- "EPSG:32615"

path <- "/home/ajackson/Dropbox/Rprojects/TexasDioceseCreationCare/Data/"

Parishes <- readRDS(paste0(path, "Parishes_plus_Census_tracts.rds"))

Census <- readRDS(paste0(path, "Census_data_for_Texas_by_tract.rds"))

Convocations <- readRDS(paste0(path,"Convocations.rds")) %>% 
  select(Name) %>% 
  mutate(Label=stringr::str_remove(Name, " Convocation| Region")) %>% 
  sf::st_as_sf()

FEMA <- readRDS(paste0(path, "NRI_Table.rds")) %>% 
  select(Tract=TRACTFIPS, SocVuln=SOVI_SCORE, Resilience=RESL_SCORE, 
         Coastal_Flood_num=CFLD_EVNTS, Coastal_Flood_Freq=CFLD_AFREQ,
         Cold_num=CWAV_EVNTS, Cold_freq=CWAV_AFREQ,
         Drought_num=DRGT_EVNTS, Drought_freq=DRGT_AFREQ,
         Quake_num=ERQK_EVNTS, Quake_freq=ERQK_AFREQ,
         Hail_num=HAIL_EVNTS, Hail_freq=HAIL_AFREQ,
         Heat_num=HWAV_EVNTS, Heat_freq=HWAV_AFREQ,
         Hurricane_num=HRCN_EVNTS, Hurricane_freq=HRCN_AFREQ,
         Ice_num=ISTM_EVNTS, Ice_freq=ISTM_AFREQ,
         Lightning_num=LTNG_EVNTS, Lightning_freq=LTNG_AFREQ,
         River_Flood_num=RFLD_EVNTS, River_Flood_freq=RFLD_AFREQ,
         Wind_num=SWND_EVNTS, Wind_freq=SWND_AFREQ,
         Tornado_num=TRND_EVNTS, Tornado_freq=TRND_AFREQ,
         Wildfire_num=WFIR_EVNTS, Wildfire_freq=WFIR_AFREQ,
         Winter_num=WNTW_EVNTS, Winter_freq=WNTW_AFREQ
         )

```

##        First add list of census tracts to each convocation

```{r add tracts}

Pos_to_GEOID <- function(Position_list, Census_df){
  return(Census_df$GEOID[Position_list])
}

a <- sf::st_intersects(Convocations, Census, sparse=TRUE)

temp <- Census
temp[6897,] <- temp[6896,]
temp$GEOID[6897] <- 0

Convocations$Tracts <- list(0)
for (i in 1:nrow(Convocations)) {
  Convocations$Tracts[i] <- list(Pos_to_GEOID(a[[i]], temp))
}



```

##        Maps by convocation of Frequency and Annual Occurrance

```{r convo}



```





