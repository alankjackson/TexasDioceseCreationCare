---
title: "First Street Flood"
author: "Alan Jackson"
format: html
editor: visual
---

## Read in and analyze the First Street Foundation flood data

Data acquired from FSF through a request on an AWS server After access granted, copied to a bucket on my AWS account Then downloaded (one at a time) the files to my PC

```{r setup}

library(tidyverse)

path <- "/home/ajackson/Dropbox/Rprojects/TexasDioceseCreationCare/Data/"

#   Some useful data

Census <- readRDS(paste0(path, "Census_data_for_Texas_by_tract.rds"))

Convocations <- readRDS(paste0(path, "Convocation_and_tracts.rds"))

```

## Read the data in by census tract and filter out diocese

```{r}

df <- read_csv(paste0(path, "FSF_Flood/fsf_flood_tract_summary.csv")) %>% 
  rename(GEOID=fips)

#   Add polygons and census data

df2 <- inner_join(df, Census, by="GEOID") %>%
  sf::st_as_sf() %>% 
  sf::st_make_valid()

#   Add Convocations and filter out data ouside the diocese

Convocations <- Convocations %>% 
  sf::st_drop_geometry() %>% 
  unnest_longer(Tract) %>% 
  filter(Tract != "48071710600") %>% # unoccupied spoil banks in Galveston Bay
  rename(GEOID=Tract) 

Convocations <- left_join(Convocations, df2, by="GEOID")

# Tract_geoms <- Census %>% 
#   select(Tract=GEOID)  

Convocations <- Convocations %>% 
  mutate(Name=stringr::str_remove(Name, " Convocation| Region")) %>% 
  # left_join(., Tract_geoms, by="Tract") %>% 
  sf::st_as_sf()

# df2 %>%
#   mutate(Fact5=count_floodfactor5/count_property*100) %>% 
#   # mutate(count_floodfactor10=pmin(count_floodfactor10, 100)) %>% 
#   ggplot() + 
#   geom_histogram(aes(x=Fact5))

df3 <- Convocations %>% 
  mutate(Fact5=count_floodfactor5/count_property*100)  
  

#   make a diagnostic map

tmap::tmap_options(basemaps="OpenStreetMap")

tmap::tmap_mode("view") # set mode to interactive plots

tmap::tm_shape(df3) + 
    #tmap::tm_sf(col="ConvoColor", alpha=0.3) +
  tmap::tm_fill(col = "Fact5", title = "Flood Factor 5 Percent", alpha=0.3, style="pretty")+
  tmap::tm_borders(lwd=0.1) 



```

## Make maps of flood factor 3, 5, and 8 colored by percent houses affected for the diocese

```{r whole diocese}

foo <- Convocations %>% 
  arrange(GEOID) %>% 
  filter(!duplicated(GEOID)) %>% 
  mutate(Fact3=count_floodfactor3/count_property*100) %>%  
  mutate(Fact5=count_floodfactor5/count_property*100) %>% 
  mutate(Fact8=count_floodfactor8/count_property*100)  

foo %>% ggplot(aes(x=Fact3)) +
  geom_histogram()

foo <- foo %>% 
  mutate(Fact3_grp = cut(Fact3,
                     breaks=c(0,5,10,20,40,100),
                     labels=c("0%-5%", "5%-10%", "10%-20%", "20%-40%", "40%-100%"),
                     include.lowest = TRUE))

  box <- foo %>%
    sf::st_bbox() 
  
  Base_basemapR <- basemapR::base_map(box, basemap="mapnik", increase_zoom=2)
  
 #Colour Palette
pal <- c(
  "40%-100%" = "red",
  "20%-40%" = "orange", 
  "10%-20%" = "yellow", 
  "5%-10%" = "lightgreen",
  "0%-5%" = "white" 
)                          
    
    foo %>% 
      ggplot() +
      Base_basemapR +
      geom_sf(aes(fill=Fact3_grp) ,alpha=0.6, lwd=0.0) +
      scale_fill_manual( values=pal,
                         limits=names(pal),
                         name="Area Flooded") +
      annotate("text", label="
             Data sourced from FEMA, National Risk Index, March 2023 
             Map a product of Alan Jackson", 
             x=-Inf, 
             y=-Inf,
             hjust="inward", vjust="inward", size = 2)
    
      # ggsave(paste0(output_path, "FEMA_Risk_",Control[i,]$Freq_var, "_", 
      #               paste(Convo, sep="_"), "_.jpg"))

  



```
